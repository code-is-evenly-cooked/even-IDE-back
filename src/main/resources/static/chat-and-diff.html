<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>채팅 + 코드 편집기</title>
  <style>
    body {
      display: flex;
      gap: 20px;
      padding: 20px;
      font-family: sans-serif;
    }
    #chat, #editor {
      width: 48%;
    }
    #chat ul {
      border: 1px solid #ccc;
      height: 200px;
      padding: 10px;
      overflow-y: scroll;
      background: #f9f9f9;
    }
    textarea {
      width: 100%;
      height: 200px;
    }
  </style>
</head>
<body>
<div id="chat">
  <h3>채팅</h3>
  <ul id="chatList"></ul>
  <input id="chatInput" placeholder="메시지 입력" />
  <button onclick="sendChat()">전송</button>
</div>

<div id="editor">
  <h3>코드 편집기</h3>
  <textarea id="codeArea" placeholder="코드 입력..."></textarea>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
  const projectId = "123";
  const fileId = 1;
  let sender = null;
  let nickname = null;
  const token = localStorage.getItem("accessToken");

  const socket = new SockJS("http://localhost:8080/ws");
  const client = Stomp.over(socket);

  let lastValue = "";

  function connect() {
    client.connect({}, () => {
      client.subscribe("/topic/project/" + projectId, (msg) => {
        const chat = JSON.parse(msg.body);
        const li = document.createElement("li");
        li.textContent = `[${chat.nickname}] ${chat.content}`;
        document.getElementById("chatList").appendChild(li);
      });

      client.subscribe(`/topic/project/${projectId}/file/${fileId}`, (msg) => {
        const data = JSON.parse(msg.body);
        if (data.sender === sender) return;
        const textarea = document.getElementById("codeArea");

        const before = lastValue;
        const updated =
          before.slice(0, data.from.column) +
          data.text +
          before.slice(data.to.column);

        textarea.value = updated;
        lastValue = updated;
        console.log("📥 수신된 diff 메시지:", data);
      });

      client.send("/app/chat.join", {}, JSON.stringify({
        type: "JOIN", projectId, sender, nickname
      }));
    });
  }

  function sendChat() {
    const content = document.getElementById("chatInput").value;
    if (!content.trim()) return;

    client.send("/app/chat.send", {}, JSON.stringify({
      type: "MESSAGE", projectId, sender, nickname, content
    }));
    document.getElementById("chatInput").value = "";
  }

  function sendDiffUpdate(newValue) {
    const prev = lastValue;
    const curr = newValue;

    let start = 0;
    while (
      start < prev.length &&
      start < curr.length &&
      prev[start] === curr[start]
    ) start++;

    let end = 0;
    while (
      end < prev.length - start &&
      end < curr.length - start &&
      prev[prev.length - 1 - end] === curr[curr.length - 1 - end]
    ) end++;

    const inserted = curr.slice(start, curr.length - end);
    const message = {
      type: "CODE_DIFF",
      projectId,
      fileId,
      sender,
      nickname,
      text: inserted,
      from: { lineNumber: 0, column: start },
      to: { lineNumber: 0, column: prev.length - end },
      timestamp: new Date().toISOString()
    };

    client.send("/app/code.diff", {}, JSON.stringify(message));
    lastValue = curr;
  }

  let timeout = null;
  document.getElementById("codeArea").addEventListener("input", (e) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      sendDiffUpdate(e.target.value);
    }, 500);
  });

  const headers = { "Content-Type": "application/json" };
  if (token) headers["Authorization"] = `Bearer ${token}`;

  fetch("http://localhost:8080/chat/join", {
    method: "POST",
    headers,
    body: JSON.stringify({ projectId })
  })
  .then(res => res.json())
  .then(data => {
    sender = data.sender;
    nickname = data.nickname;
    connect();
  });
</script>
</body>
</html>